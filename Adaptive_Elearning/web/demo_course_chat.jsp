<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ page import="controller.ChatController" %>
<%@ page import="model.Conversations" %>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Auto-Join Course Group Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .demo-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .demo-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .sample-data {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .navigation a {
            background-color: #27ae60;
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .navigation a:hover {
            background-color: #229954;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>üéì Demo Auto-Join Course Group Chat</h1>
        
        <div class="info">
            <strong>M√¥ t·∫£ ch·ª©c nƒÉng:</strong> Khi m·ªôt user ƒëƒÉng k√Ω (enroll) v√†o m·ªôt kh√≥a h·ªçc, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông:
            <ul>
                <li>T·∫°o group chat cho kh√≥a h·ªçc ƒë√≥ (n·∫øu ch∆∞a c√≥)</li>
                <li>Th√™m user v√†o group chat</li>
                <li>User c√≥ th·ªÉ chat v·ªõi c√°c h·ªçc vi√™n kh√°c trong c√πng kh√≥a h·ªçc</li>
            </ul>
        </div>
        
        <!-- Demo Auto-Join Course -->
        <div class="demo-section">
            <h3>üîß Test Auto-Join Course Group</h3>
            <p>M√¥ ph·ªèng vi·ªác user ƒëƒÉng k√Ω kh√≥a h·ªçc v√† ƒë∆∞·ª£c t·ª± ƒë·ªông th√™m v√†o group chat</p>
            
            <form method="post" action="">
                <input type="hidden" name="action" value="joinCourse">
                
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" name="userId" value="522d2265-0532-4142-8079-0aa7e9c7d3cb" required>
                </div>
                
                <div class="form-group">
                    <label for="courseId">Course ID:</label>
                    <input type="text" id="courseId" name="courseId" value="69746c85-6109-4370-9334-1490cd2334b0" required>
                </div>
                
                <button type="submit">üöÄ ƒêƒÉng k√Ω kh√≥a h·ªçc & Join Group Chat</button>
            </form>
            
            <div class="sample-data">
                <strong>Sample Data c√≥ s·∫µn trong database:</strong><br>
                User ID: 9f32b3ba-e7c5-4f58-81b8-8096f6f99c79<br>
                Course ID: 550e8400-e29b-41d4-a716-446655440000 (Course demo)
            </div>
        </div>
        
        <!-- Hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <%
            String message = null;
            String messageType = "info";
            
            if ("POST".equals(request.getMethod())) {
                String action = request.getParameter("action");
                
                if ("joinCourse".equals(action)) {
                    String userId = request.getParameter("userId");
                    String courseId = request.getParameter("courseId");
                    
                    if (userId != null && courseId != null && !userId.trim().isEmpty() && !courseId.trim().isEmpty()) {
                        try {
                            ChatController chatController = new ChatController();
                            
                            // M√¥ ph·ªèng vi·ªác user enroll v√†o course v√† auto-join group chat
                            boolean success = chatController.handleCourseEnrollment(userId.trim(), courseId.trim());
                            
                            if (success) {
                                // L·∫•y th√¥ng tin conversation ƒë√£ join
                                Conversations conversation = chatController.getCourseConversation(courseId.trim());
                                
                                if (conversation != null) {
                                    message = "‚úÖ Th√†nh c√¥ng! User ƒë√£ ƒë∆∞·ª£c th√™m v√†o group chat: " + conversation.getTitle() + 
                                             " (ID: " + conversation.getId() + ")";
                                    messageType = "success";
                                } else {
                                    message = "‚úÖ User ƒë√£ ƒë∆∞·ª£c th√™m v√†o course group, nh∆∞ng kh√¥ng th·ªÉ l·∫•y th√¥ng tin conversation.";
                                    messageType = "success";
                                }
                            } else {
                                message = "‚ùå Kh√¥ng th·ªÉ th√™m user v√†o course group. Ki·ªÉm tra l·∫°i User ID v√† Course ID.";
                                messageType = "error";
                            }
                            
                        } catch (Exception e) {
                            message = "‚ùå L·ªói: " + e.getMessage();
                            messageType = "error";
                            e.printStackTrace();
                        }
                    } else {
                        message = "‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß User ID v√† Course ID.";
                        messageType = "error";
                    }
                }
            }
        %>
        
        <% if (message != null) { %>
            <div class="<%= messageType %>">
                <%= message %>
            </div>
        <% } %>
        
        <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
        <div class="demo-section">
            <h3>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <ol>
                <li>Nh·∫≠p User ID v√† Course ID v√†o form tr√™n</li>
                <li>Nh·∫•n "ƒêƒÉng k√Ω kh√≥a h·ªçc & Join Group Chat"</li>
                <li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o group chat cho kh√≥a h·ªçc (n·∫øu ch∆∞a c√≥)</li>
                <li>User s·∫Ω ƒë∆∞·ª£c th√™m v√†o group chat</li>
                <li>Sau ƒë√≥ c√≥ th·ªÉ v√†o trang chat ƒë·ªÉ xem v√† g·ª≠i tin nh·∫Øn</li>
            </ol>
        </div>
        
        <!-- Database Info -->
        <div class="demo-section">
            <h3>üóÑÔ∏è Th√¥ng tin Database</h3>
            <p>H·ªá th·ªëng s·ª≠ d·ª•ng c√°c b·∫£ng sau ƒë·ªÉ qu·∫£n l√Ω chat group:</p>
            <ul>
                <li><strong>Conversations:</strong> L∆∞u th√¥ng tin group chat</li>
                <li><strong>ConversationMembers:</strong> L∆∞u danh s√°ch members trong group</li>
                <li><strong>ChatMessages:</strong> L∆∞u tin nh·∫Øn</li>
                <li><strong>Users:</strong> Th√¥ng tin users</li>
                <li><strong>Courses:</strong> Th√¥ng tin kh√≥a h·ªçc</li>
                <li><strong>Enrollments:</strong> Th√¥ng tin ƒëƒÉng k√Ω kh√≥a h·ªçc</li>
            </ul>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <a href="course_group_chat.jsp?userId=9f32b3ba-e7c5-4f58-81b8-8096f6f99c79">
                üöÄ V√†o trang Chat Group
            </a>
        </div>
    </div>
</body>
</html>